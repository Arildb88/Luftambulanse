
@using Gruppe4NLA.Models
@model ReportModelWrapper
@* This tells the view it will receive and bind to a single Report object *@

@{
    ViewData["Title"] = "Add Report"; 
    @* Sets the page title *@
}

<h2>Add a new Report</h2>

@if (ViewBag.Message != null)
{
    <p style="color:green">@ViewBag.Message</p>
}

@* Form that posts data to the Create action in ReportsController *@

<br>
<form asp-action="Create" method="post">
    
    @* Adding spacing and changing the style *@
    <style>
        .form-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .form-group label {
            width: 100px;
            margin-right: 10px;
            margin-left: 10px;
            text-align: left;
        }

        .form-group input {
            flex: 1; 
            padding: 5px;
        }

    </style>

    @* Sender name input *@
    <div class="form-group">
        <label asp-for="NewCoordinate.SenderName"></label>
        <input asp-for="NewCoordinate.SenderName" class="form-control" />
        <span asp-validation-for="NewCoordinate.SenderName" class="text-danger"></span>
    </div>

    @* Latitude input *@
    <div class="form-group">
        <label asp-for="NewCoordinate.Latitude"></label>
        <input asp-for="NewCoordinate.Latitude" type="number" step="any" />
        <span asp-validation-for="NewCoordinate.Latitude" class="text-danger"></span>
    </div>

    @* Longitude input *@
    <div class="form-group">
        <label asp-for="NewCoordinate.Longitude"></label>
        <input asp-for="NewCoordinate.Longitude" type="number" step="any" />
        <span asp-validation-for="NewCoordinate.Longitude" class="text-danger"></span>
    </div>

    @* Danger type input *@
    <div class="form-group">
        <label asp-for="NewCoordinate.DangerType"></label>
        <input asp-for="NewCoordinate.DangerType" class="form-control" />
    </div>

    @* Extra details textarea *@
    <div class="form-group">
        <label asp-for="NewCoordinate.Details"></label>
        <textarea asp-for="NewCoordinate.Details" class="form-control"></textarea>
    </div>

    @* Save and Cancel buttons *@
    <button type="submit" class="btn btn-success mt-3">Save</button>
    <a asp-action="Index" class="btn btn-secondary mt-3">Cancel</a>
</form>

<!-- Makes button -->
<br>
<button id="btnAdd" class="btnSimple" type="button">Open Map</button>

<!-- Title for submitted coordinates -->

<h3><br>Submitted Coordinates</h3>

<!-- Variable "coord" will show for each instance -->
<ul>
    @foreach (var coord in Model.SubmittedCoordinates)
    {
        <li>
            Lat: @(coord.Latitude?.ToString("F6") ?? "N/A"),
            Lng: @(coord.Longitude?.ToString("F6") ?? "N/A")
        </li>
    }
</ul>


<!-- Styling the map -->
<div id="mapModal" style="
            display:none;
            position:fixed;
            top:50%;
            left:50%;
            transform:translate(-50%, -50%);
            width:80%;
            height:80%;
            background:white;
            border:1px solid black;
            padding:10px;
            z-index:1000;
        ">
    <div id="map" style="width:100%; height:90%;"></div>
    
    <div id="buttonsGroup" style="display: flex; justify-content: center; gap: 10px; padding-top: 10px;">
        <button id="btnSaveLocation" class="btnSimple">Save Location</button>
        <button id="btnCloseMap" class="btnBack">Close</button>
    </div>

</div>

<!-- Script to make map -->
@section Scripts {
    <partial name="_ValidationScriptsPartial" />


    <!-- Import map through link (should be downloaded later) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>



    <script>

        // Initialize map and marker

        var map, marker;

        // Button to add coordinates

        document.getElementById("btnAdd").onclick = function() {
            document.getElementById("mapModal").style.display = "block";

            // Set view and zoom

            if (!map) {
                map = L.map('map', { minZoom: 4 }).setView([58.1638332, 7.9812789], 13);
                L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);

                // Add marker where the user clicks

                map.on('click', function(e) {
                    if (marker) marker.setLatLng(e.latlng);
                    else marker = L.marker(e.latlng).addTo(map);
                });
            }
        };

        // Save location when clicked

        document.getElementById("btnSaveLocation").onclick = function(e) {
            e.preventDefault();
            if (marker) {
                document.getElementById("NewCoordinate_Latitude").value = marker.getLatLng().lat.toFixed(6);
                document.getElementById("NewCoordinate_Longitude").value = marker.getLatLng().lng.toFixed(6);
            }
            document.getElementById("mapModal").style.display = "none";
        };

        // Close map when clicked. Does not save data.

        document.getElementById("btnCloseMap").onclick = function(e) {
            e.preventDefault();
            document.getElementById("mapModal").style.display = "none";
        };
    </script>
}