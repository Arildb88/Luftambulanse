@model IEnumerable<ReportModel>
@using Gruppe4NLA.Models
@using System.Text.Json.Nodes
@{
    ViewData["Title"] = "FullMap";
    Layout = "_Layout";

    var stadiaApiKey = Context.Items["StadiaApiKey"] as string;

    // Combine all reports into a single FeatureCollection
    var allFeatures = new List<JsonObject>();

    foreach (var report in Model.Where(r => !string.IsNullOrEmpty(r.GeoJson)))
    {
        var doc = JsonNode.Parse(report.GeoJson);
        if (doc?["features"] is JsonArray features)
        {
            foreach (var feature in features)
            {
                var f = feature.AsObject();

                var props = f["properties"] as JsonObject ?? new JsonObject();
                props["Type"] = report.Type?.ToString();
                props["ReportID"] = report.Id;
                f["properties"] = props;

                var geom = f["geometry"]?.AsObject();
                if (geom != null && !geom.ContainsKey("type"))
                {
                    var coords = geom["coordinates"];
                    if (coords is JsonArray arr && arr.Count > 0)
                    {
                        if (arr[0] is JsonValue) 
                        {
                            geom["type"] = "Point";
                        }
                        else 
                        {
                            geom["type"] = "LineString";
                        }
                    }
                }

                allFeatures.Add(f);
            }
        }
    }

    var combinedGeoJson = System.Text.Json.JsonSerializer.Serialize(new { type = "FeatureCollection", features = allFeatures });
}

<h2>Full Map</h2>

<div id="map" style="height: calc(77vh - 2vh); width: 100%; margin-bottom: 2vh; position: relative;"></div>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    
    const stadiaApiKey = '@stadiaApiKey';
    
    var map = L.map('map').setView([60, 10], 5); 
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
       
    var geoData = JSON.parse('@combinedGeoJson'.replace(/&quot;/g, '"')); 

        var geoLayer = L.geoJSON(geoData, {
        onEachFeature: function (feature, layer) {
            layer.bindPopup("<strong>Type:</strong> " + feature.properties.Type +
                            "<br><strong>ID:</strong> " + feature.properties.ReportID);
        
        if (feature.geometry.type === "LineString") {
            const coords = feature.geometry.coordinates;
            coords.forEach(coord => {
                const latlng = [coord[1], coord[0]];
                L.circleMarker(latlng, {
                    radius: 4,
                    fillColor: "var(--warning-color)",
                    color: "#000",
                    weight: 1,
                    fillOpacity: 1
                }).addTo(map);
            });
        }
        },

        pointToLayer: function(feature, latlng) {
            if (feature.properties.Type === "Pole") {
            svgIcon = `
                <svg xmlns="http://www.w3.org/2000/svg"
                     viewBox="0 0 24 24" width="25" height="25">
                    <circle cx="12" cy="12" r="8"
                          fill="var(--warning-color)"
                          stroke="black" stroke-width="2" />
                </svg>
            `;
        }
        else if (feature.properties.Type === "Cable") {
            svgIcon = `
                <svg xmlns="http://www.w3.org/2000/svg"
                     viewBox="0 0 24 24" width="25" height="25">
                    <circle cx="12" cy="12" r="8"
                            fill="var(--warning-color)"
                            stroke="black" stroke-width="2" />
                </svg>
            `;
        }
        else {
            svgIcon = `
                <svg xmlns="http://www.w3.org/2000/svg"
                     viewBox="0 0 24 24" width="25" height="25">
                    <polygon points="12,2 22,22 2,22"
                             fill="var(--warning-color)"
                             stroke="black" stroke-width="2" />
                </svg>
            `;
        }

        // Use L.divIcon to render inline SVG with CSS variable colors
        return L.marker(latlng, {
            icon: L.divIcon({
                html: svgIcon,
                className: 'custom-icon',
                iconSize: [25, 25],
                iconAnchor: [12, 25]
            })
        });
    },
        style: function(feature) {
            
            if (feature.geometry.type === "LineString") {
                return {
                    color: "var(--warning-color)",
                    weight: 3
                };
            }
            return {};
        }
    }).addTo(map);

    map.fitBounds(geoLayer.getBounds());

</script>