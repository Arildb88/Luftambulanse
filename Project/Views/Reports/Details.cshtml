@*
    summary: View for displaying detailed information about a specific report,
             including options for caseworkers to approve or reject the report.
*@

@model Gruppe4NLA.Models.ReportModel

@{
    ViewData["Title"] = "Report Details";
}

<h2>Report Details</h2>

@if (TempData["Ok"] != null)
{
    <div class="alert alert-success">@TempData["Ok"]</div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

<div class="card" style="background-color: var(--base-variant)">
    <div class="card-body" style="color: var(--text-color)">
        <dl class="row">
            <dt class="col-sm-3">Report ID</dt>
            <dd class="col-sm-9">@Model.Id</dd>

            <dt class="col-sm-3">Sender</dt>
            <dd class="col-sm-9">@Model.SenderName</dd>

            <dt class="col-sm-3">Type</dt>
            <dd class="col-sm-9">@Model.Type</dd>

            <dt class="col-sm-3">Details</dt>
            <dd class="col-sm-9">@(Model.Details ?? "N/A")</dd>

            <dt class="col-sm-3">Height</dt>
            <dd class="col-sm-9">@(Model.HeightInMeters?.ToString("F2") ?? "N/A") meters</dd>

            <dt class="col-sm-3">Lighted</dt>
            <dd class="col-sm-9">@(Model.AreLighted ? "Yes" : "No")</dd>

            <dt class="col-sm-3">Coordinates</dt>
            <dd class="col-sm-9">
                Lat: @(ViewBag.Latitude?.ToString("F6") ?? "N/A"),
                Lng: @(ViewBag.Longitude?.ToString("F6") ?? "N/A")
            </dd>

            <dt class="col-sm-3">Date Sent</dt>
            <dd class="col-sm-9">@Model.DateSent.ToString("yyyy-MM-dd HH:mm")</dd>

            <dt class="col-sm-3">Status</dt>
            <dd class="col-sm-9">
                <span class="badge bg-@( // Choose badge color based on status
                      Model.StatusCase == Gruppe4NLA.Models.ReportStatusCase.Submitted ? "secondary" :
                      Model.StatusCase == Gruppe4NLA.Models.ReportStatusCase.Assigned ? "primary" :
                      Model.StatusCase == Gruppe4NLA.Models.ReportStatusCase.InReview ? "warning" :
                      Model.StatusCase == Gruppe4NLA.Models.ReportStatusCase.Completed ? "success" : "danger")">
                    @Model.StatusCase
                </span>
            </dd>
                       
            @if (!string.IsNullOrEmpty(Model.AssignedToUserId)) // Only show if assigned
            {
                <dt class="col-sm-3">Assigned To</dt>
                <dd class="col-sm-9">@(ViewBag.AssignedToEmail ?? Model.AssignedToUserId)</dd>
            }
        </dl>

        @* Show approve/reject buttons for assigned caseworker only *@
        @if ((User.IsInRole("Caseworker") || User.IsInRole("CaseworkerAdm")) &&
                Model.AssignedToUserId == User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value &&
                Model.StatusCase != Gruppe4NLA.Models.ReportStatusCase.Completed &&
                Model.StatusCase != Gruppe4NLA.Models.ReportStatusCase.Rejected)
        {
            <hr />
            <div class="mt-3">
                <h5>Review Actions</h5>

                <form asp-action="Approve" asp-route-id="@Model.Id" method="post" style="display:inline;">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-success"
                            onclick="return confirm('Are you sure you want to approve this report?')">
                        Approve Report
                    </button>
                </form>

                <form asp-action="Reject" asp-route-id="@Model.Id" method="post" class="mt-2">
                    @Html.AntiForgeryToken()

                    <div class="mb-2">
                        <label for="rejectReason" class="form-label"><strong>Reason for rejection</strong></label>
                        <textarea id="rejectReason"
                              name="rejectReportReason"
                              class="form-control"
                              rows="3"
                              maxlength="500"
                              required></textarea>
                        <small class="text-muted">This text will be visible to the pilot.</small>
                    </div>

                    <button type="submit"
                            id="rejectButton"
                            class="btn btn-danger"
                            disabled
                            onclick="return confirm('Are you sure you want to reject this report?');">
                        Reject Report
                    </button>
                </form>
            </div>
        }

        @if (Model.StatusCase == Gruppe4NLA.Models.ReportStatusCase.Completed) // Show status messages
        {
            <div class="alert alert-success mt-3">
                This report has been approved.
            </div>
        }
        else if (Model.StatusCase == Gruppe4NLA.Models.ReportStatusCase.Rejected) // Show rejection reason
        {
            <div class="alert alert-danger mt-3">
                This report has been rejected.
                 @if (!string.IsNullOrWhiteSpace(Model.RejectReportReason))
                {
                    <hr />
                    <strong>Reason:</strong>
                    <div>@Model.RejectReportReason</div>
                } 
            </div>
        }

        <!-- Leaflet map for this report -->
        <hr />
        <h5>Location Map</h5>
        <div id="reportMap" style="height:400px;"></div>

        <!-- 🔹 All coordinates (for lines) will be rendered here -->
        <div id="coordList" class="mt-3"></div>
    </div>
</div>

<div class="mt-3">
    @if (User.IsInRole("Caseworker") || User.IsInRole("CaseworkerAdm")) // Show "Back to My Queue" for caseworkers
    {
        <a asp-action="MyQueue" class="btn btn-secondary">Back to My Queue</a>
    }
    <a asp-action="Index" class="btn btn-secondary">Back to Reports</a>
</div>

    @section Scripts { 
    <link rel="stylesheet" href="~/lib/LeafletMap/leaflet.css" />
    <script src="~/lib/LeafletMap/leaflet.js"></script>

    <script>

        // Initialize Leaflet map with GeoJSON or coordinates
        (function () {
            // GeoJSON (for point OR line)
            const geoJsonRaw = @Html.Raw(Model.GeoJson ?? "null");
            let geoJsonObject = geoJsonRaw;

            // If GeoJSON is stored as a string, parse it into an object
            if (typeof geoJsonRaw === "string") {
                try {
                    geoJsonObject = JSON.parse(geoJsonRaw);
                } catch (e) {
                    geoJsonObject = null;
                }
            }

            // Normalize geometry.type like in FullMap (Point vs LineString)
            function ensureGeometryType(geom) {
                if (!geom) return;
                if (geom.type) return; // already has type

                const coords = geom.coordinates;
                if (!Array.isArray(coords) || coords.length === 0) return;

                // [[lon, lat], ...] → LineString
                if (Array.isArray(coords[0])) {
                    geom.type = "LineString";
                }
                else {
                    // [lon, lat] → Point
                    geom.type = "Point";
                }
            }

            function normalizeGeoJson(geo) {
                if (!geo) return null;

                // FeatureCollection
                if (geo.type === "FeatureCollection" && Array.isArray(geo.features)) {
                    geo.features.forEach(f => {
                        if (f && f.geometry) {
                            ensureGeometryType(f.geometry);
                        }
                    });
                    return geo;
                }

                // Single Feature
                if (geo.type === "Feature" && geo.geometry) {
                    ensureGeometryType(geo.geometry);
                    return geo;
                }

                // Raw geometry
                ensureGeometryType(geo);
                return geo;
            }

            geoJsonObject = normalizeGeoJson(geoJsonObject);

            // Lat/Lng from ViewBag (fallback)
            const haveLat = @((ViewBag.Latitude != null) ? "true" : "false");
            const haveLng = @((ViewBag.Longitude != null) ? "true" : "false");
            const latVal = @((ViewBag.Latitude ?? 0.0).ToString(System.Globalization.CultureInfo.InvariantCulture));
            const lngVal = @((ViewBag.Longitude ?? 0.0).ToString(System.Globalization.CultureInfo.InvariantCulture));

            // If we have neither GeoJSON nor coordinates, nothing to show
            if (!geoJsonObject && !(haveLat && haveLng)) {
                return;
            }

            const map = L.map('reportMap'); // No initial center/zoom

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { // OSM tiles
                maxZoom: 19
            }).addTo(map);

            if (geoJsonObject) {
                // Draw GeoJSON (point or line) and fit map to it
                const layer = L.geoJSON(geoJsonObject).addTo(map);
                const bounds = layer.getBounds();
                if (bounds.isValid()) {
                    map.fitBounds(bounds, { maxZoom: 16 });
                } else if (haveLat && haveLng) {
                    map.setView([latVal, lngVal], 14);
                }

                // Extract all coordinates from the GeoJSON
                function extractCoords(geo) {
                    if (!geo) return [];

                    if (geo.type === 'FeatureCollection') {
                        return geo.features.flatMap(f => extractCoords(f.geometry || f));
                    }

                    if (geo.type === 'Feature') {
                        return extractCoords(geo.geometry);
                    }

                    if (geo.type === 'LineString') {
                        return geo.coordinates.map(c => ({ lng: c[0], lat: c[1] }));
                    }

                    if (geo.type === 'Point') {
                        return [{ lng: geo.coordinates[0], lat: geo.coordinates[1] }];
                    }

                    return [];
                }

                // Get all coordinates and display them in the coordList div
                const coords = extractCoords(geoJsonObject);

                // Only show the list if it's a line (more than one coordinate)
                const coordDiv = document.getElementById('coordList');
                if (coordDiv && coords.length > 1) {
                    let html = '<h6>All coordinates in line</h6><ol class="mb-0 small">';
                    coords.forEach(c => {
                        const lat = Number(c.lat).toFixed(6);
                        const lng = Number(c.lng).toFixed(6);
                        html += `<li>Lat: ${lat}, Lng: ${lng}</li>`;
                    });
                    html += '</ol>';
                    coordDiv.innerHTML = html;
                }

            } else if (haveLat && haveLng) {
                // Fallback: just a single marker
                map.setView([latVal, lngVal], 14);
                L.marker([latVal, lngVal]).addTo(map);
            }
        })();
    </script>

    @* Script to make the Reason button only be pressable when theres text in the reason field*@
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const reasonInput = document.getElementById('rejectReason');
            const rejectButton = document.getElementById('rejectButton');

            if (!reasonInput || !rejectButton) return;

            function toggleRejectButton() {
                const hasText = reasonInput.value.trim().length > 0;
                rejectButton.disabled = !hasText;
            }

            // Init state
            toggleRejectButton();

            // Update on typing
            reasonInput.addEventListener('input', toggleRejectButton);
        });
    </script>
}



