@using Gruppe4NLA.Models
@model ReportModel
@* This view displays details of a single Report object *@

@{
    @* Sets the page title *@
    ViewData["Title"] = "Report Details";
     
     var typeText = Model.Type == ReportModel.DangerTypeEnum.Other
        ? (Model.OtherDangerType ?? "Other")
        : (Model.Type.ToString() ?? "â€“");
   
}

<h2>Report Details</h2>

<div class="fullPage">
    @* Display sender name *@
    <p><strong>Sender:</strong> @Model.SenderName</p>

    @* Display latitude *@
    <p><strong>Latitude:</strong> @Model.Latitude</p>

    @* Display longitude *@
    <p><strong>Longitude:</strong> @Model.Longitude</p>

    @* Display Height Inn Meters *@
    <p><strong>Height (Meters):</strong> @Model.HeightInnMeters</p>

    @* Display ObstacleType and if "Other" show that*@
    <p><strong>Obstacle Type:</strong> @typeText</p>

    @* Display extra details *@
    <p><strong>Details:</strong> @Model.Details</p>

    @* Display Are lighted (Boolean) *@
    <p><strong>Lights:</strong> @Model.AreLighted</p>

    @* Display date *@
    <p><strong>Date sent:</strong> @Model.DateSent</p>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<link rel="stylesheet" href="map.css">

<!-- Styling the map -->
<div id="mapModal" style="
            display:none;
            position:absolute;
            top:50%;
            left:50%;
            transform:translate(-50%, -50%);
            width:70%;
            height:80%;
            background:DarkGreen;
            border:4px solid black;
            padding:10px;
            z-index:1000;
        ">
    <div id="map" style="width:100%; height:90%;"></div>
    
    <div id="buttonsGroup" style="display: flex; justify-content: center; gap: 10px; padding-top: 10px;">
            <button id="btnCloseMap" class="btnBack">Close</button>
            <button id="btnMoveModal" class="btnSimple" type="button">Move Map</button>
    </div>

</div>

<!-- Button to show coords -->
<button id="btnShowCoords" class="btnSimple" type="button">Show coordinates on map</button>

<!-- Script to make map -->
@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <!-- Import map through link (should be downloaded later) -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
    
            var map, obstacleMarker, osm;
            let isDraggable = false;

            // "modal" gets "mapModal"
            const modal = document.getElementById("mapModal");
            
            // Show map when button is clicked
            document.getElementById("btnShowCoords").onclick = function() {
                document.getElementById("mapModal").style.display = "block";

            // Set view and zoom
        if (!map) {
                map = L.map('map', { minZoom: 4 }).setView([@Model.Latitude, @Model.Longitude], 13);
            
            // Makes marker with dangertype
            obstacleMarker = L.marker([@Model.Latitude, @Model.Longitude], { draggable: false })
            .bindPopup("@typeText").addTo(map);
                
            osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            L.control.layers(
                { 'OSM': osm },
                { 'Marker': obstacleMarker },
                { collapsed: false }
            ).addTo(map);

        } else {
            
                map.invalidateSize();
        }

    };

            document.getElementById("btnCloseMap").onclick = function() {
                document.getElementById("mapModal").style.display = "none";
            };

            document.getElementById("btnMoveModal").onclick = function () {
                isDraggable = !isDraggable;
                this.textContent = isDraggable ? "Lock Map" : "Move Map";
            };

            // Makes a draggable element

            dragElement(modal);

            function dragElement(elmnt) {
                let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

                elmnt.onmousedown = dragMouseDown;

                // Activates if the mouse button is pushed down
                function dragMouseDown(e) {
                    if (!isDraggable) return;
                    e.preventDefault();
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    document.onmouseup = closeDragElement;
                    document.onmousemove = elementDrag;

                }

                // Lets the user move the element
                function elementDrag(e) {
                    e.preventDefault();
                    pos1 = pos3 - e.clientX;
                    pos2 = pos4 - e.clientY;
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                    elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";

                    if (map) map.invalidateSize();
                }

                // Clears the moving when mouse is up or not moving
                function closeDragElement() {
                    document.onmouseup = null;
                    document.onmousemove = null;
                }
        }

    </script>  

}
@* Back to list link *@
<a asp-action="Index" class="btnBack">Back to Reports</a>