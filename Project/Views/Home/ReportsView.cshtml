@using Gruppe4NLA.Areas.Identity.Data
@using Microsoft.AspNetCore.Identity

@* 
    Summary: View for displaying a list of reports with filtering and sorting options.
    Users can view, edit, submit, and delete reports based on their roles and report status.
*@

@inject UserManager<ApplicationUser> UserManager 
@{
    var me = await UserManager.GetUserAsync(User); 
    var myId = me?.Id;
    var myEmail = me?.Email; 
}

@model List<Gruppe4NLA.Models.ReportModel>
@{
    ViewData["Title"] = "Reports";
    var filter = (ViewData["Filter"] as string) ?? "all";

    var rsort = (ViewBag.RSort as string) ?? "DateSent";
    var rdir = (ViewBag.RDir as string) ?? "desc";

    Func<string, string> NextR = col => // Determine the next sort direction for a given column
        (rsort.Equals(col, StringComparison.OrdinalIgnoreCase) && rdir == "asc") ? "desc" : "asc";

    Func<string, string> ArrowR = col => // Determine the sort arrow for a given column
        rsort.Equals(col, StringComparison.OrdinalIgnoreCase) ? (rdir == "asc" ? "▲" : "▼") : "";
}
<style> 
    .rsort-link {
        text-decoration: none;
        white-space: nowrap;
    }

        .rsort-link .caret {
            margin-left: .25rem;
            font-size: .8rem;
        }
</style>


<h2>Reports</h2> 
@if (TempData["Message"] != null)
{
    <div class="alert alert-success">@TempData["Message"]</div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

<div class="btn-group mb-3" role="group">
    <a asp-action="Index" asp-route-filter="all"
       class="btn @(filter == "all" ? "btn-primary" : "btn-outline-primary")">
        All Reports
    </a>
    <a asp-action="Index" asp-route-filter="submitted"
       class="btn @(filter == "submitted" ? "btn-primary" : "btn-outline-primary")">
        Submitted
    </a>
    <a asp-action="Index" asp-route-filter="drafts"
       class="btn @(filter == "drafts" ? "btn-primary" : "btn-outline-primary")">
        Drafts
    </a>
</div>

@if (!Model.Any()) // Check if there are no reports
{
    <p>No reports found.</p>
}
else // If there are reports, display them in a table
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>
                    <a asp-action="Index"
                       asp-route-filter="@filter"
                       asp-route-rsort="Sender"
                       asp-route-rdir="@NextR("Sender")"
                       class="rsort-link">
                        Sender <span class="caret">@ArrowR("Sender")</span>
                    </a>
                </th>                
                <th>
                    <a asp-action="Index"
                       asp-route-filter="@filter"
                       asp-route-rsort="Height"
                       asp-route-rdir="@NextR("Height")"
                       class="rsort-link">
                        Height (m) <span class="caret">@ArrowR("Height")</span>
                    </a>
                </th>
                <th>
                    <a asp-action="Index"
                       asp-route-filter="@filter"
                       asp-route-rsort="Type"
                       asp-route-rdir="@NextR("Type")"
                       class="rsort-link">
                        Type <span class="caret">@ArrowR("Type")</span>
                    </a>
                </th>
                <th>
                    <a asp-action="Index"
                       asp-route-filter="@filter"
                       asp-route-rsort="DateSent"
                       asp-route-rdir="@NextR("DateSent")"
                       class="rsort-link">
                        Date Sent <span class="caret">@ArrowR("DateSent")</span>
                    </a>
                </th>
                <th>
                    <a asp-action="Index"
                       asp-route-filter="@filter"
                       asp-route-rsort="Status"
                       asp-route-rdir="@NextR("Status")"
                       class="rsort-link">
                        Status <span class="caret">@ArrowR("Status")</span>
                    </a>
                </th>
                <th>Actions</th>
                 <th>Review note</th>
            </tr>
        </thead>
        <tbody>

            @foreach (var report in Model)
            {
                <tr>
                    <td>@report.SenderName</td>
                    <td>@report.HeightInMeters?.ToString("F2")</td>
                    <td>@report.Type.ToString()</td>
                    <td>@report.DateSent.ToString("yyyy-MM-dd HH:mm")</td>
                    <td>
                        @* summary: Display the report status with appropriate badge color *@
                        <span class="badge bg-@(report.StatusCase == Gruppe4NLA.Models.ReportStatusCase.Submitted ? "secondary" : 
                                                report.StatusCase == Gruppe4NLA.Models.ReportStatusCase.Draft ? "warning" :
                                                report.StatusCase == Gruppe4NLA.Models.ReportStatusCase.Assigned ? "primary" :
                                                report.StatusCase == Gruppe4NLA.Models.ReportStatusCase.InReview ? "warning" :
                                                report.StatusCase == Gruppe4NLA.Models.ReportStatusCase.Completed ? "success" : "danger")">

                                              @(report.StatusCase == Gruppe4NLA.Models.ReportStatusCase.Completed ? "Approved" :
                                                report.StatusCase == Gruppe4NLA.Models.ReportStatusCase.Rejected ? "Rejected" :
                                                report.StatusCase.ToString())
                </span>
            </td>
            <td>
                @{
                            var canDelete =
                            User.IsInRole("Admin") ||
                            User.IsInRole("CaseworkerAdm") ||
                            User.IsInRole("Caseworker") ||
                            // Pilot: only own drafts
                            (User.IsInRole("Pilot")
                            && report.StatusCase == Gruppe4NLA.Models.ReportStatusCase.Draft
                            && (report.UserId == myId ||
                            (report.UserId == null && string.Equals(report.SenderName, myEmail, StringComparison.OrdinalIgnoreCase))));
                        }

                        <a asp-action="Details" asp-route-id="@report.Id" class="btn btn-sm btn-info">Details</a>

                        @if (canDelete) // Show delete button if user has permission
                        {
                            <form asp-action="Delete"
                                  asp-route-id="@report.Id"
                                  asp-route-returnUrl="@($"{Context.Request.Path}{Context.Request.QueryString}")"
                                  method="post" class="d-inline"
                                  onsubmit="return confirm('Delete this report? This cannot be undone.');">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                            </form>
                        }

                        @if (report.StatusCase == Gruppe4NLA.Models.ReportStatusCase.Draft) // Only show for drafts
                        {
                            <a asp-action="Edit" asp-route-id="@report.Id" class="btn btn-sm btn-warning">Edit</a>
                            <form asp-action="Submit" asp-route-id="@report.Id" method="post" class="d-inline">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-sm btn-success">Submit</button>
                            </form>
                        }
                    </td>

                     @*Short version of RejectReportReason*@
                    <td>
                        @{
                            string? note = null;

                            if (report.StatusCase == Gruppe4NLA.Models.ReportStatusCase.Rejected &&
                            !string.IsNullOrWhiteSpace(report.RejectReportReason))
                            {
                                note = report.RejectReportReason;
                            }

                            if (string.IsNullOrEmpty(note))
                            {
                                @:—
                            }
                            else
                            {
                                var maxLen = 10;
                                var shortNote = note.Length > maxLen
                                ? note.Substring(0, maxLen) + "..."
                                : note;

                                @shortNote
                            }
                        }
                    </td> 
                </tr>
            }
        </tbody>
    </table>
}

<a asp-action="Map" asp-controller="Home" class="btn btn-primary">Create New Report</a>
